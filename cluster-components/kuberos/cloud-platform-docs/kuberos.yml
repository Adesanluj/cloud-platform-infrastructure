---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kuberos-oidc-env
data:
  OIDC_ISSUER_URL: "https://cloud-platform-docs.eu.auth0.com/"
  OIDC_CLIENT_ID: "4ec2rrn6Vxc5tP1hkzL8NR5IZAGWPj9X"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: templates
data:
  kubecfg: |
    apiVersion: v1
    kind: Config
    clusters:
    - cluster:
        certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMwekNDQWJ1Z0F3SUJBZ0lNRlVMQVpyZ25kZUJUbkxzM01BMEdDU3FHU0liM0RRRUJDd1VBTUJVeEV6QVIKQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13SGhjTk1UZ3dOekUzTVRFd05qRXdXaGNOTWpnd056RTJNVEV3TmpFdwpXakFWTVJNd0VRWURWUVFERXdwcmRXSmxjbTVsZEdWek1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBCk1JSUJDZ0tDQVFFQXVyazhYVVNiWmV1ZktYbGlZTjcwRko5VTVzQ2J0Wk1CdGdrd0NXM1M1YkdtYXRzdUpqUFEKUG9URnNPdG1qaCtZbHVQdjRYQkoxZUwyanhtUVJISjArcm9HQ3pEcUFISHIvS3B3V1VwU3BpanJmeVdSMDNNVwpJOFZhekxvb3ZGb1g3bUE0UDNDOHFlaHhqTEcwNk8vNnlrMGFJOFA5Tk8vdVdkVVB6dFZndVRvZmNBTzkyd2VYCkdsK2JjNVB4SFFOZ1haanh4YnV6Y1lVQm14Z3h3NUhoakVJWjV2bjhHenJrL1RXSkdmSVpJc0l3OFkyL1NXalcKNWFjdnVJTk5KV3l5YVhYNHhySFlld2JJbEtCQUNiUDE1UU8zYUNuT093SlFZTUpyYTdpWlZFZUUwUTdta3lLMwpzSTREeTgzY2NCY2xSSExyUVllajJ6Y01qakdpSVpQUHRRSURBUUFCb3lNd0lUQU9CZ05WSFE4QkFmOEVCQU1DCkFRWXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFjQkJCYWxDWG9iUTgKQjVhMkgrTXhUYWtsRWhXZzE5ajRnWmo3TVFMZ0Y5dmJ6Rm1sNDJ2bFpVaW83MWh2eWRMUTNqYTM2WUhoS0NJLwp2U0NnOTFvOWxQSVJaTFc4T1pRWDg5RjBReUhoYUJqdHM3dCtibVlxRlBqYjlmelRBeDd2RXFWTm5xS0tMNXUyCjJ1WitaWWpEbDRRNzJSS1RDc3NXVmxTTzZXNE5oaDJvL1lqOURscGtLRmN6akx2NHZLWGQrayszMzdoUysrKzMKNTBqeUxiN29DaFNYanVkZTVpbjhNQjQ4VmovZDg5OEZZaGZQbFJ0Mll2TlZyU2J0R21sNHd5RXU2RU1Bb0RVaApxY3JacnVtNlNzQzh0ai9KaCtQdFhlY21hNlQ5ekhXRWViUkkyci81S1Z4Vkw4SjdwcFFNQUd0Um9odUV5dUdsCmI0YkM0QzdxWFE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
        server: https://api.cloud-platform-docs.k8s.integration.dsd.io
      name: cloud-platform-docs.k8s.integration.dsd.io
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: kuberos
  annotations:
    kubernetes.io/ingress.class: "nginx"
spec:
  rules:
  - host: login.apps.cloud-platform-docs.k8s.integration.dsd.io
    http:
      paths:
      - path: /
        backend:
          serviceName: kuberos
          servicePort: http
---
apiVersion: v1
kind: Service
metadata:
  name: kuberos
spec:
  ports:
  - port: 80
    name: http
    targetPort: http
  selector:
    app: kuberos
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: kuberos
spec:
  template:
    metadata:
      labels:
        app: kuberos
    spec:
      containers:
      - name: kuberos
        image: negz/kuberos:14f4ca7
        command:
        - "/kuberos"
        - "$(OIDC_ISSUER_URL)"
        - "$(OIDC_CLIENT_ID)"
        - "/oidc/secret"
        - "/templates/kubecfg"

        envFrom:
        - configMapRef:
            name: kuberos-oidc-env

        ports:
        - containerPort: 10003
          name: http

        volumeMounts:
        - name: oidc
          mountPath: /oidc
        - name: templates
          mountPath: /templates

      volumes:
      - name: oidc
        secret:
          secretName: kuberos-oidc

      - name: templates
        configMap:
          name: templates
